{% extends "partner_app/base.html" %}
{% load static %}
{% load tz %}


{% load django_vite %}
{% vite_hmr_client %}
{% block title %}Личный кабинет{% endblock title %}
{% block head_js_scripts %}
{% vite_asset 'partner_app/assets/js/dashboard/advertiser.js' %}
{% endblock %}


{% block header %}
<div class="navbar bg-white shadow-lg sticky top-0 z-50" id="navbar">
    <div class="navbar-start">
        <div class="dropdown lg:hidden">
            <div tabindex="0" role="button" class="btn btn-ghost">
                <i class="fas fa-bars text-lg"></i>
            </div>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                <li><a class="nav-item active" data-page="dashboard"><i class="fas fa-chart-line mr-2"></i>
                        Статистика</a></li>
                <li><a class="nav-item" data-page="projects"><i class="fas fa-boxes mr-2"></i> Проекты</a></li>
                <li><a class="nav-item" data-page="partners"><i class="fas fa-handshake mr-2"></i> Партнеры</a></li>
                <li><a class="nav-item" data-page="payments"><i class="fas fa-money-bill-wave mr-2"></i> Выплаты</a>
                </li>
                <li><a class="nav-item" data-page="settings"><i class="fas fa-cog mr-2"></i> Настройки</a></li>
            </ul>
        </div>
        <a href="{% url 'index' %}"
            class="btn btn-ghost border-none text-xl font-bold text-blue-600 hover:scale-105 transition-transform">
            <i class="fas fa-handshake text-blue-600 mr-2"></i>
            <span class="hidden sm:inline">AffiliateHub</span>
            <span class="sm:hidden">AH</span>
        </a>
    </div>
    <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
            <li><a class="nav-item active" data-page="dashboard"><i class="fas fa-chart-line mr-2"></i> Статистика</a>
            </li>
            <li><a class="nav-item" data-page="projects"><i class="fas fa-boxes mr-2"></i> Проекты</a></li>
            <li><a class="nav-item" data-page="partners"><i class="fas fa-handshake mr-2"></i> Партнеры</a></li>
            <li><a class="nav-item" data-page="payments"><i class="fas fa-money-bill-wave mr-2"></i> Выплаты</a></li>
            <li><a class="nav-item" data-page="settings"><i class="fas fa-cog mr-2"></i> Настройки</a></li>
        </ul>
    </div>
    <div class="navbar-end">
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
                    <i class="fas fa-user text-lg mt-2.5 ml-0.5"></i>
                </div>
            </div>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box">
                <li><a href="{% url 'dashboard' %}" class="text-lg w-full"><i class="fas fa-user mr-2"></i> Профиль</a>
                </li>
                <li class="w-full p-0 cursor-pointer">
                    <form action="{% url 'logout' %}" class="flex justify-between w-full cursor-pointer" method="post">
                        {% csrf_token %}
                        <button type="submit"
                            class="hover:bg-gray-200 text-lg flex justify-start w-30 cursor-pointer"><i class="fas fa-sign-out-alt mr-2"></i> Выход</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block main_class %}bg-base-200 min-h-screen{% endblock %}

{% block content %}
<div class="bg-base-200 min-h-screen">
    <!-- Весь HTML контент из оригинального <body> -->
    <div class="container mx-auto px-4 py-6 max-w-7xl">

        <!-- Dashboard Page -->
        <div id="dashboard" class="page-section active">
            <div class="mb-8">
                {% if request.user.first_name %}
                <h1 class="text-3xl font-bold">Добро пожаловать, {{ request.user.first_name }}!</h1>
                {% else %}
                <h1 class="text-3xl font-bold">Добро пожаловать!</h1>
                {% endif %}
                <p class="text-base-content/60">Рекламодатель с {{ request.user.date_joined|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card bg-gradient-to-r from-primary to-secondary text-white">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Баланс</p>
                                <p class="text-2xl font-bold">₽45,250</p>
                            </div>
                            <i class="fas fa-wallet text-3xl opacity-80"></i>
                        </div>
                    </div>
                </div>

                <div class="card bg-gradient-to-r from-accent to-info text-white">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Активные партнеры</p>
                                <p class="text-2xl font-bold">24</p>
                            </div>
                            <i class="fas fa-users text-3xl opacity-80"></i>
                        </div>
                    </div>
                </div>

                <div class="card bg-gradient-to-r from-success to-warning text-white">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Конверсия</p>
                                <p class="text-2xl font-bold">8.5%</p>
                            </div>
                            <i class="fas fa-percentage text-3xl opacity-80"></i>
                        </div>
                    </div>
                </div>

                <div class="card bg-gradient-to-r from-warning to-error text-white">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm opacity-80">Продажи</p>
                                <p class="text-2xl font-bold">142</p>
                            </div>
                            <i class="fas fa-shopping-cart text-3xl opacity-80"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-2 space-y-6">


                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-trophy text-primary mr-2"></i>
                                Топ партнеры
                            </h2>
                            <div class="overflow-x-auto">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Партнер</th>
                                            <th>Продажи</th>
                                            <th>Доход</th>
                                            <th>Комиссия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="flex items-center gap-3">
                                                    <div class="avatar">
                                                        <div class="w-8 rounded-full bg-neutral text-neutral-content">
                                                            <span>MP</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="font-bold">Мария Петрова</div>
                                                        <div class="text-sm opacity-50">Блогер</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>42</td>
                                            <td>₽125,400</td>
                                            <td><span class="badge badge-primary">₽12,540</span></td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="flex items-center gap-3">
                                                    <div class="avatar">
                                                        <div class="w-8 rounded-full bg-neutral text-neutral-content">
                                                            <span>ИП</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="font-bold">Иван Иванов</div>
                                                        <div class="text-sm opacity-50">Сайт</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>38</td>
                                            <td>₽98,700</td>
                                            <td><span class="badge badge-primary">₽9,870</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Sales -->
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-history text-primary mr-2"></i>
                                Последние продажи
                            </h2>
                            <div class="space-y-4">
                                <div class="flex items-center p-3 bg-success/10 rounded-lg">
                                    <div
                                        class="w-10 h-10 bg-success text-success-content rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium">Продажа #2456</p>
                                        <p class="text-sm opacity-60">Партнер: Мария Петрова</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">₽12,540</p>
                                        <p class="text-sm opacity-60">2 часа назад</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-info/10 rounded-lg">
                                    <div
                                        class="w-10 h-10 bg-info text-info-content rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium">Продажа #2455</p>
                                        <p class="text-sm opacity-60">Партнер: Иван Иванов</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold">₽9,870</p>
                                        <p class="text-sm opacity-60">5 часов назад</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Quick Actions -->
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-bolt text-primary mr-2"></i>
                                Быстрые действия
                            </h2>
                            <div class="space-y-2">
                                <button id="add_project_quick" class="btn btn-outline btn-block justify-start nav-item" data-page="projects">
                                    <i class="fas fa-plus mr-2"></i>
                                    Добавить проект
                                </button>
                                <button class="btn btn-outline btn-block justify-start nav-item" data-page="payments">
                                    <i class="fas fa-money-bill-wave mr-2"></i>
                                    Создать выплату
                                </button>
                                <button class="btn btn-outline btn-block justify-start nav-item">
                                    <i class="fas fa-file-alt mr-2"></i>
                                    Отчет за месяц
                                </button>
                                <button class="btn btn-outline btn-block justify-start nav-item">
                                    <i class="fas fa-headset mr-2"></i>
                                    Поддержка
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Program Stats -->
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie text-primary mr-2"></i>
                                Статистика программы
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Конверсия</span>
                                        <span>8.5%</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>Средний чек</span>
                                        <span>₽3,240</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Page -->
        <div id="projects" class="page-section">
            <div class="mb-8">
                <h1 class="text-3xl font-bold">Управление проектами</h1>
                <p class="text-base-content/60">Создавайте и настраивайте проекты для партнеров</p>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="join">
                    <div>
                        <div>
                            <input class="input input-bordered join-item" placeholder="Поиск проектов...">
                        </div>
                    </div>
                    <select class="select select-bordered join-item">
                        <option disabled selected>Фильтры</option>
                        <option>Все проекты</option>
                        <option>Активные</option>
                        <option>Неактивные</option>
                        
                        <option>На модерации</option>
                        <option>Неактивные</option>
                        <option>Подтверждено</option>
                        <option>Отклонено</option>
                        <option>Заблокировано</option>
                    </select>
                    <div class="indicator">
                        <button class="btn join-item btn-primary">
                            <i class="fas fa-search mr-2"></i> Найти
                        </button>
                    </div>
                </div>

                <button class="btn btn-primary" id="create_project">
                    <i class="fas fa-plus mr-2"></i> Новый проект
                </button>
            </div>

            {% if messages %}
                {% for message in messages %}
                    {% if "project_add_error" in message.tags %}
                        <div class="alert alert-{{ message.tags }} text-red-500">
                            <b>{{ message }}</b>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for project in projects %}
                <div class="card bg-base-100 shadow-md offer-card">
                    <div class="card-body pt-4">
                        <div class="flex justify-between items-start">
                            <h2 class="card-title">{{ project.name }}</h2>
                            <div
                                class="badge {% if project.is_active %}badge-success{% else %}badge-error{% endif %} gap-2">
                                <i class="fas {% if project.is_active %}fa-check{% else %}fa-times{% endif %}"></i>
                                {% if project.is_active %}Активен{% else %}Неактивен{% endif %}
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Статус:</span>
                                <span class="badge {% if project.status == 'Подтверждено' %}badge-success
                                    {% elif project.status == 'На модерации' %}badge-warning
                                    {% else %}badge-error{% endif %}">
                                    {{ project.status }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">URL проекта:</span>
                                <span><a href="{{ project.url }}" class="text-blue-600"
                                        target="_blank">перейти</a></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Комиссия:</span>
                                <span class="font-bold">{{ project.commission_rate }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Партнеров:</span>
                                <span>{{ project.partners.count }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Время добавления:</span>
                                <span>{{ project.created_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</span>
                            </div>
                        </div>
                        <div class="card-actions mt-6">
                            <button class="addProjectModal btn btn-primary btn-block" data-project-id="{{ project.id }}"
                                data-project-name="{{ project.name }}"
                                data-project-description="{{ project.description }}"
                                data-project-url="{{ project.url }}" data-project-status="{{ project.status }}"
                                data-project-is-active="{{ project.is_active|yesno:'true,false' }}"
                                data-project-partners-count="{{ project.partners.count }}"
                                data-project-commission-rate="{{ project.commission_rate }}"
                                data-project-min-payout="{{ project.min_payout }}"
                                data-project-cookie-lifetime="{{ project.cookie_lifetime }}">
                                <i class="fas fa-eye mr-2"></i> Просмотр
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-10">
                    <p class="text-gray-500">Проекты не найдены</p>
                </div>
                {% endfor %}
            </div>
            <!-- Пагинация -->

            <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
                {% if projects.has_previous %}
                <a href="?page=1"
                    class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                    aria-label="Первая страница">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page={{ projects.previous_page_number }}"
                    class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                    <span class="hidden sm:inline">Предыдущая</span>
                    <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
                </a>
                {% endif %}

                <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
                    <span class="hidden sm:inline">Страница</span>
                    <input type="number" min="1" max="{{ projects.paginator.num_pages }}" value="{{ projects.number }}"
                        class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                        onchange="window.location.href = '?page=' + this.value" aria-label="Номер страницы">
                    <span>из {{ projects.paginator.num_pages }}</span>
                </div>

                {% if projects.has_next %}
                <a href="?page={{ projects.next_page_number }}"
                    class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                    <span class="hidden sm:inline">Следующая</span>
                    <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
                </a>
                <a href="?page={{ projects.paginator.num_pages }}"
                    class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                    aria-label="Последняя страница">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Partners Page -->
        <div id="partners" class="page-section">
            <div class="mb-8">
                <h1 class="text-3xl font-bold">Партнеры</h1>
                <p class="text-base-content/60">Управление партнерами вашей программы</p>
            </div>

            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="card-title">
                            <i class="fas fa-users text-primary mr-2"></i>
                            Все партнеры
                        </h2>
                        <div class="flex gap-2">
                            <div class="form-control">
                                <input type="text" placeholder="Поиск партнеров..." class="input input-bordered">
                            </div>
                            <button class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i>
                                Добавить
                            </button>
                        </div>
                    </div>

                    <div class="overflow-visible">
                        <table class="table overflow-visible">
                            <thead>
                                <tr>
                                    <th>Партнер</th>
                                    <th>Тип</th>
                                    <th>Продажи</th>
                                    <th>Доход</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <div class="avatar">
                                                <div class="w-10 rounded-full">
                                                    <img src="https://randomuser.me/api/portraits/women/12.jpg"
                                                        alt="Аватар Марии Петровой">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-bold">Мария Петрова</div>
                                                <div class="text-sm opacity-50">maria@example.com</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Блогер</td>
                                    <td>42</td>
                                    <td>₽125,400</td>
                                    <td><span class="badge badge-success">Активен</span></td>
                                    <td>
                                        <!-- Кнопка с выпадающим меню -->
                                        <div class="dropdown dropdown-end">
                                            <button tabindex="0" class="btn btn-ghost btn-xs">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <!-- Список действий -->
                                            <ul tabindex="0"
                                                class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                                <li><a onclick="openPartnerModal('maria@example.com')"><i
                                                            class="fas fa-user-circle mr-2"></i>Профиль</a></li>
                                                <li><a onclick="openChat('maria@example.com')"><i
                                                            class="fas fa-comment mr-2"></i>Написать</a></li>
                                                <li><a onclick="editCommission(42)"><i
                                                            class="fas fa-percent mr-2"></i>Изменить комиссию</a></li>
                                                <li class="menu-title mt-2">
                                                    <span>Администрирование</span>
                                                </li>
                                                <li><a onclick="togglePartnerStatus('maria@example.com')"
                                                        class="text-yellow-600"><i
                                                            class="fas fa-power-off mr-2"></i>Приостановить</a></li>
                                                <li><a onclick="confirmDelete('maria@example.com')"
                                                        class="text-error"><i
                                                            class="fas fa-trash-alt mr-2"></i>Удалить</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <div class="avatar">
                                                <div class="w-10 rounded-full">
                                                    <img src="https://randomuser.me/api/portraits/men/32.jpg">
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-bold">Иван Иванов</div>
                                                <div class="text-sm opacity-50">ivan@example.com</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Сайт</td>
                                    <td>38</td>
                                    <td>₽98,700</td>
                                    <td><span class="badge badge-success">Активен</span></td>
                                    <td>
                                        <button class="btn btn-ghost btn-xs">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Пагинация -->
                </div>
            </div>
        </div>

        <!-- Payments Page -->
        <div id="payments" class="page-section">
            <div class="mb-8">
                <h1 class="text-3xl font-bold">Выплаты</h1>
                <p class="text-base-content/60">История выплат партнерам</p>
            </div>

            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="card-title">
                            <i class="fas fa-money-bill-wave text-primary mr-2"></i>
                            История выплат
                        </h2>
                        <div class="flex gap-2">
                            <button class="btn btn-primary">
                                <i class="fas fa-plus mr-2"></i>
                                Новая выплата
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Партнер</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                    <th>Детали</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>15.06.2024</td>
                                    <td>Мария Петрова</td>
                                    <td class="font-bold">₽12,540</td>
                                    <td><span class="badge badge-success">Выплачено</span></td>
                                    <td>
                                        <button class="btn btn-ghost btn-xs">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>10.06.2024</td>
                                    <td>Иван Иванов</td>
                                    <td class="font-bold">₽9,870</td>
                                    <td><span class="badge badge-success">Выплачено</span></td>
                                    <td>
                                        <button class="btn btn-ghost btn-xs">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page-section">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-base-content mb-2">Настройки</h1>
                <p class="text-base-content/60">Управление аккаунтом и настройки профиля</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <!-- Profile Settings -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title mb-4">
                                <i class="fas fa-user text-primary mr-2"></i>
                                Профиль
                            </h2>
                            <form method="POST" action="{% url 'dashboard' %}" id="profile_settings_form"
                                class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% csrf_token %}
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Имя</span>
                                    </label>
                                    <input name="first_name" type="text" value="{{ request.user.first_name }}"
                                        class="input input-bordered" required />
                                </div>
                                <input name="profile_submit" type="text" value="1" class="hidden" />
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Фамилия</span>
                                    </label>
                                    <input name="last_name" type="text" value="{{ request.user.last_name }}"
                                        class="input input-bordered" required />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Email</span>
                                    </label>
                                    <input name="email" type="email" value="{{ request.user.email }}"
                                        class="input input-bordered" required />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Телефон</span>
                                    </label>
                                    <input name="phone" type="tel" value="{{ request.user.phone|default:'' }}"
                                        class="input input-bordered" required />
                                </div>
                                <div class="form-control md:col-span-2">
                                    <label class="label">
                                        <span class="label-text">О себе</span>
                                    </label>
                                    <textarea name="description" class="textarea textarea-bordered"
                                        placeholder="Расскажите о себе..."
                                        required>{{ request.user.description }}</textarea>
                                </div>
                            </form>
                            <div class="card-actions flex justify-end mt-4">
                                <button form="profile_settings_form" class="btn btn-primary">
                                    <i class="fas fa-save mr-2"></i>
                                    Сохранить изменения
                                </button>
                            </div>
                            {% if messages %}
                                {% for message in messages %}
                                    {% if "profile_update_error" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-red-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                    {% if "profile_update_success" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-green-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title mb-4">
                                <i class="fas fa-shield-alt text-primary mr-2"></i>
                                Безопасность
                            </h2>
                            <form id="change_password_form" action="{% url 'dashboard' %}" class="space-y-4"
                                method="POST">
                                {% csrf_token %}
                                <input name="password_submit" value="1" class="hidden">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Текущий пароль</span>
                                    </label>
                                    <input name="old_password" type="password" class="input input-bordered"
                                        placeholder="Введите текущий пароль" required />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Новый пароль</span>
                                    </label>
                                    <input name="password1" type="password" class="input input-bordered"
                                        placeholder="Введите новый пароль" required />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Подтвердите пароль</span>
                                    </label>
                                    <input name="password2" type="password" class="input input-bordered"
                                        placeholder="Повторите новый пароль" required />
                                </div>
                            </form>
                            <div class="card-actions justify-end mt-4">
                                <button form="change_password_form" class="btn btn-warning">
                                    <i class="fas fa-key mr-2"></i>
                                    Изменить пароль
                                </button>
                            </div>
                            {% if messages %}
                                {% for message in messages %}
                                    {% if "password_update_error" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-red-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                    {% if "password_update_success" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-green-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Notification Settings -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title mb-4">
                                <i class="fas fa-bell text-primary mr-2"></i>
                                Уведомления
                            </h2>
                            <form class="space-y-4" method="post" action="{% url 'update_notifications_settings' %}">
                                {% csrf_token %}
                                <div class="form-control">
                                    <label class="label cursor-pointer flex justify-between">
                                        <span class="label-text">Email уведомления</span>
                                        <input name="email_notifications"  type="checkbox" class="toggle toggle-primary" {% if user.email_notifications %}checked{% endif %}/>
                                    </label>
                                </div>
                                <div class="card-actions flex justify-end mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save mr-2"></i>
                                        Сохранить изменения
                                    </button>
                                </div>
                            </form>
                            {% if messages %}
                                {% for message in messages %}
                                    {% if "update_notifications_success" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-green-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- API Settings -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title mb-4">
                                <i class="fas fa-code text-primary mr-2"></i>
                                API настройки
                            </h2>
                            <form id="apiSettingsForm" method="post" action="{% url 'update_api_settings' %}">
                                {% csrf_token %}
                                <div class="space-y-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">{{ apiSettingsForm.api_key.label }}</span>
                                        </label>
                                        <div class="join w-full">
                                            {{ apiSettingsForm.api_key|default:"" }}
                                            <button type="button" id="show_api_key" class="btn join-item">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" id="copy_api_key" class="btn join-item">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <button type="button" id="generate_api_key" class="btn btn-outline btn-block">
                                        <i class="fas fa-sync mr-2"></i>
                                        Сгенерировать новый ключ
                                    </button>

                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-save mr-2"></i> Сохранить API-ключ
                                    </button>

                                    <div class="text-sm text-base-content/60">
                                        <p>
                                            <i class="fas fa-info-circle mr-1"></i> API документация доступна в разделе
                                            помощи
                                        </p>
                                    </div>
                                </div>
                            </form>
                            {% if messages %}
                                {% for message in messages %}
                                    {% if "update_api_error" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-red-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                    {% if "update_api_success" in message.tags %}
                                        <div class="alert alert-{{ message.tags }} text-green-500">
                                            <b>{{ message }}</b>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <!-- Модальное окно создания проекта -->
    <dialog id="createProjectModal" class="modal">
        <div class="modal-box max-w-2xl bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Создание нового проекта</h2>

            <form method="post" action="{% url 'add_project' %}">
                {% csrf_token %}

                <!-- Название проекта -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ projectForm.name.label }}
                    </label>
                    {{ projectForm.name }}
                    {% if projectForm.name.errors %}
                    <div class="text-red-500 text-xs mt-1">{{ projectForm.name.errors }}</div>
                    {% endif %}
                </div>

                <!-- Описание -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ projectForm.description.label }}
                    </label>
                    {{ projectForm.description }}
                </div>

                <!-- URL проекта -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ projectForm.url.label }}
                    </label>
                    {{ projectForm.url }}
                    {% if projectForm.url.errors %}
                    <div class="text-red-500 text-xs mt-1">{{ projectForm.url.errors }}</div>
                    {% endif %}
                </div>

                <!-- Минимальная выплата -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ projectForm.min_payout.label }}
                    </label>
                    {{ projectForm.min_payout }}
                    {% if projectForm.min_payout.errors %}
                    <div class="text-red-500 text-xs mt-1">{{ projectForm.min_payout.errors }}</div>
                    {% endif %}
                </div>

                <!-- Комиссия и Куки -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ projectForm.commission_rate.label }}
                        </label>
                        {{ projectForm.commission_rate }}
                        {% if projectForm.commission_rate.errors %}
                        <div class="text-red-500 text-xs mt-1">{{ projectForm.commission_rate.errors }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ projectForm.cookie_lifetime.label }}
                        </label>
                        {{ projectForm.cookie_lifetime }}
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="flex justify-end gap-3">
                    <a id="close_create_project_modal" class="btn btn-ghost">Отмена</a>
                    <button type="submit" class="btn btn-primary">Добавить проект</button>
                </div>
            </form>
        </div>
    </dialog>


    <dialog id="projectDetailsModal" class="modal">
        <div class="modal-box max-w-5xl p-0 overflow-y-auto max-h-screen">

            <!-- Header -->
            <div class="bg-gradient-to-r from-primary to-primary-focus p-6 pt-12 text-white">
                <h3 id="ProjectTitle" class="text-xl font-bold">Летняя распродажа 2023</h3>
                <div class="flex flex-wrap items-center mt-2 gap-2">
                    <div id="ProjectStatusBadge" class="badge badge-accent">
                        <p id="ProjectStatusText">Активный</p>
                    </div>
                </div>
            </div>

            <!-- Body content -->
            <div class="p-4 space-y-4">
                <!-- Project Info -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="card-title text-lg">
                            Описание проекта
                        </h4>
                        <p id="ProjectDescription" class="mt-2 text-gray-600 text-sm">
                            Описание
                        </p>
                    </div>
                </div>

                <!-- Performance Stats -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="card-title text-lg">
                            Статистика
                        </h4>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div class="stats shadow compact">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Партнёров</div>
                                    <div id="ProjectPartnersCount" class="stat-value text-primary text-lg">24</div>
                                </div>
                            </div>
                            <div class="stats shadow compact">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Конверсия</div>
                                    <div id="ProjectConversion" class="stat-value text-secondary text-lg">0%</div>
                                </div>
                            </div>
                            <div class="stats shadow compact w-full">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Комиссия</div>
                                    <div id="ProjectComissionRate" class="stat-value text-lg">15%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Offer Details -->
                <div class="card bg-base-100 shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="card-title text-lg">
                            Условия
                        </h4>
                        <div class="space-y-2 mt-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Минимальная выплата:</span>
                                <span id="MinPayout" class="font-medium">1 000 ₽</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Срок cookie-файлов:</span>
                                <span id="CookiePeriod" class="font-medium">30 дней</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-action bg-base-200 p-3 sticky bottom-0">
                <button id="closeProjectDetailsModal" class="btn btn-sm w-full">Закрыть</button>
            </div>
        </div>
    </dialog>
    {% endblock content %}