{% load static %}
{% load tz %}

<div id="partners" class="page-section px-4 sm:px-0">
    <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-base-content">Партнеры</h1>
        <p class="text-sm sm:text-base text-base-content/60">Управление партнерами вашей программы</p>
    </div>

    <div class="card bg-base-100 shadow-sm sm:shadow-lg">
        <div class="card-body p-2 sm:p-4 md:p-6">
            <div class="mb-6">
                <form method="get" action="" class="flex flex-col sm:flex-row gap-2 w-full">
                    <!-- Поле поиска - занимает всю доступную ширину -->
                    <div class="flex-grow">
                        <input name="partners_search" class="input input-bordered w-full"
                            placeholder="Поиск партнёров..." value="{{ partners_search_query }}">
                    </div>

                    <!-- Группа кнопок - выравнивание по правому краю на десктопе -->
                    <div class="flex gap-2 justify-end sm:justify-start">
                        <!-- Кнопка поиска с адаптивным текстом -->
                        <button type="submit" class="btn btn-primary flex items-center">
                            <i class="fas fa-search sm:mr-2"></i>
                            <span class="hidden sm:inline">Найти</span>
                        </button>

                        <!-- Кнопка сброса с адаптивным текстом -->
                        <button type="reset" class="btn flex items-center"
                            onclick="window.location.href='{{ request.path }}'">
                            <i class="fas fa-times sm:mr-2"></i>
                            <span class="hidden sm:inline">Сбросить</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Мобильный вид (карточки) -->
            <div class="space-y-2 xs:space-y-3 sm:hidden">
                {% for partner in partners %}
                <div class="card bg-base-100 shadow-xs">
                    <div class="card-body p-2 sm:p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="overflow-hidden">
                                    <div class="font-bold text-sm sm:text-base truncate">
                                        {{ partner.get_full_name|default:partner.username }}
                                    </div>
                                    <div class="text-xs opacity-50 truncate">{{ partner.email }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="divider my-1 sm:my-2"></div>
                        <div class="grid grid-cols-2 gap-1 sm:gap-2">
                            <div>
                                <div class="text-xs text-base-content/60">Тип</div>
                                <div class="text-sm sm:text-base">
                                    {{ partner.partnerprofile.traffic_source|default:"Не указан" }}
                                </div>
                            </div>
                            <div>
                                <div class="text-xs text-base-content/60">Продажи</div>
                                <div class="text-sm sm:text-base">
                                    {{ partner.get_conversions_count|default:"0" }}
                                </div>
                            </div>
                            <div>
                                <div class="text-xs text-base-content/60">Доход</div>
                                <div class="font-bold text-sm sm:text-base">
                                    ₽{{ partner.get_total_income|default:"0" }}
                                </div>
                            </div>
                            <div class="flex items-end justify-end">
                                <div class="dropdown dropdown-end">
                                    <button tabindex="0" class="btn btn-ghost btn-xs sm:btn-sm">
                                        <i class="fas fa-eye text-xs sm:text-sm"></i>
                                    </button>
                                    <ul tabindex="0"
                                        class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48 sm:w-52">
                                        <li>
                                            <a href="{% url 'partner' partner.id %}" class="text-xs sm:text-sm">
                                                <i class="fa-solid fa-circle-user"></i>Просмотр
                                            </a>
                                        </li>
                                        <li class="menu-title mt-1 sm:mt-2 text-xs sm:text-sm">
                                            <span>Администрирование</span>
                                        </li>
                                        <li>
                                            <a class="text-xs sm:text-sm text-error">
                                                <i class="fas fa-trash-alt mr-1 sm:mr-2"></i>Удалить
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400">
                    Партнёры не найдены
                </div>
                {% endfor %}
            </div>

            <!-- Десктопный вид (таблица) -->
            <div class="hidden sm:block">
                <div class="overflow-visible">
                    <table class="table table-sm md:table-md">
                        <thead>
                            <tr>
                                <th class="py-1 sm:py-2">Партнер</th>
                                <th class="py-1 sm:py-2">Продажи</th>
                                <th class="py-1 sm:py-2">Доход</th>
                                <th class="py-1 sm:py-2">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for partner in partners %}
                            <tr>
                                <td>
                                    <div class="flex items-center gap-2 sm:gap-3">
                                        <div>
                                            <div class="font-bold text-sm sm:text-base">
                                                {{ partner.get_full_name|default:partner.username }}
                                            </div>
                                            <div class="text-xs sm:text-sm opacity-50">
                                                {{ partner.email }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-sm sm:text-base">
                                    {{ partner.get_conversions_count|default:"0" }}
                                </td>
                                <td class="text-sm sm:text-base">
                                    ₽{{ partner.get_total_income|default:"0" }}
                                </td>
                                <td>
                                    <div class="dropdown dropdown-end">
                                        <button tabindex="0" class="btn btn-ghost btn-xs sm:btn-sm">
                                            <i class="fas fa-eye text-xs sm:text-sm"></i>
                                        </button>
                                        <ul tabindex="0"
                                            class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48 sm:w-52">
                                            <li>
                                                <a href="{% url 'partner' partner.id %}" class="text-xs sm:text-sm">
                                                    <i class="fa-solid fa-circle-user"></i>Просмотр
                                                </a>
                                            </li>
                                            <li class="menu-title mt-1 sm:mt-2 text-xs sm:text-sm">
                                                <span>Администрирование</span>
                                            </li>
                                            <li>
                                                <a class="stop_partnership_with_partner text-xs sm:text-sm text-error"
                                                    data-partner-id="{{ partner.id }}">
                                                    <i class="fas fa-trash-alt mr-1 sm:mr-2"></i>Удалить
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-6">
                                    <div class="text-gray-400">Партнёры не найдены</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Пагинация Партнёры -->
            <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
                {% if partners.has_previous %}
                <a href="?partners_page=1"
                    class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                    aria-label="Первая страница">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?partners_page={{ partners.previous_page_number }}"
                    class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                    <span class="hidden sm:inline">Предыдущая</span>
                    <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
                </a>
                {% endif %}

                <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
                    <span class="hidden sm:inline">Страница</span>
                    <input type="number" min="1" max="{{ partners.paginator.num_pages }}" value="{{ partners.number }}"
                        class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                        onchange="window.location.href = '?partners_page=' + this.value" aria-label="Номер страницы">
                    <span>из {{ partners.paginator.num_pages }}</span>
                </div>

                {% if partners.has_next %}
                <a href="?partners_page={{ partners.next_page_number }}"
                    class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                    <span class="hidden sm:inline">Следующая</span>
                    <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
                </a>
                <a href="?partners_page={{ partners.paginator.num_pages }}"
                    class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                    aria-label="Последняя страница">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>