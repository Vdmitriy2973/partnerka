{% load static %}
{% load tz %}

<div id="projects" class="page-section">
    <div class="mb-8">
        <h1 class="text-3xl font-bold">Управление проектами</h1>
        <p class="text-base-content/60">Создавайте и настраивайте проекты для партнеров</p>
    </div>

    <div class="flex sm:flew-row justify-between items-center mb-6">
        <div class="flex justify-between items-center mb-6">
            <form method="get" action="" class="join w-full">
                <div>
                    <div>
                        <input name="projects_search" class="input input-bordered join-item"
                            placeholder="Поиск проектов..." value="{{ projects_search_query }}">
                    </div>
                </div>
                <div class="indicator">
                    <button type="submit" class="btn join-item btn-primary">
                        <i class="fas fa-search mr-2"></i> Найти
                    </button>
                </div>
                <button type="reset" class="btn join-item" onclick="window.location.href='{{ request.path }}'">
                    <i class="fas fa-times mr-2"></i> Сбросить
                </button>
            </form>
        </div>

        <button class="btn btn-primary" id="create_project">
            <i class="fas fa-plus mr-2"></i> Новый проект
        </button>
    </div>

    <!-- Уведомления -->
    {% if messages %}
        <div class="mt-4">
            {% for message in messages %}
                {% if "project_add_success" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-green-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% elif "project_add_error" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-red-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% elif "project_edit_error" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-red-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% elif "project_edit_success" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-green-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% elif "project_delete_error" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-red-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% elif "project_delete_success" in message.extra_tags %}
                    <div class="alert alert-{{ message.tags }} text-green-500 mb-4">
                        <b>{{ message }}</b>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for project in projects %}
        <div class="card bg-base-100 shadow-md offer-card">
            <div class="card-body pt-4">
                <div class="flex justify-between items-start">
                    <h2 class="card-title">{{ project.name }}</h2>
                    <div class="badge {% if project.is_active %}badge-success{% else %}badge-error{% endif %} gap-2">
                        <i class="fas {% if project.is_active %}fa-check{% else %}fa-times{% endif %}"></i>
                        {% if project.is_active %}Активен{% else %}Неактивен{% endif %}
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Статус:</span>
                        <span class="badge {% if project.status == 'Подтверждено' %}badge-success
                                    {% elif project.status == 'На модерации' %}badge-warning
                                    {% else %}badge-error{% endif %}">
                            {{ project.status }}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">URL проекта:</span>
                        <span>
                            {% if "http" in project.url %}
                            <a href="{{ project.url }}" class="text-blue-600" target="_blank">перейти</a>
                            {% else %}
                            <p class="text-blue-600">{{ project.url }}</p>
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Комиссия:</span>
                        <span class="font-bold">{{ project.commission_rate }}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Партнеров:</span>
                        <span>{{ project.partners.count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Время добавления:</span>
                        <span>{{ project.created_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</span>
                    </div>
                </div>
                <div class="card-actions mt-6">
                    <button class="showProjectDetailsModal btn btn-primary btn-block" data-project-id="{{ project.id }}"
                        data-project-name="{{ project.name }}" data-project-description="{{ project.description }}"
                        data-project-url="{{ project.url }}" data-project-status="{{ project.status }}"
                        data-project-is-active="{{ project.is_active|yesno:'true,false' }}"
                        data-project-partners-count="{{ project.partners.count }}"
                        data-project-commission-rate="{{ project.commission_rate }}"
                        data-project-min-payout="{{ project.min_payout }}"
                        data-project-cookie-lifetime="{{ project.cookie_lifetime }}">
                        <i class="fas fa-eye mr-2"></i> Просмотр
                    </button>
                    <button class="editProjectModal btn btn-primary btn-block" data-project-id="{{ project.id }}"
                        data-project-name="{{ project.name }}" data-project-url="{{ project.url }}"
                        data-project-description="{{ project.description }}" data-project-status="{{ project.status }}"
                        data-project-is-active="{{ project.is_active|yesno:'true,false' }}"
                        data-project-commission-rate="{{ project.commission_rate }}"
                        data-project-cookie-lifetime="{{ project.cookie_lifetime }}"
                        data-project-min-payout="{{ project.min_payout }}">
                        <i class="fas fa-edit mr-1"></i> Редактировать
                    </button>
                    <button class="delProjectModal btn btn-error btn-block" data-project-id="{{ project.id }}"
                        data-project-name="{{ project.name }}">
                        <i class="fas fa-trash-alt mr-2"></i> Удалить
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-10">
            <p class="text-gray-500">Проекты не найдены</p>
        </div>
        {% endfor %}
    </div>
    <!-- Пагинация -->

    <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
        {% if projects.has_previous %}
        <a href="?projects_page=1"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Первая страница">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="?projects_page={{ projects.previous_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Предыдущая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
        </a>
        {% endif %}

        <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
            <span class="hidden sm:inline">Страница</span>
            <input type="number" min="1" max="{{ projects.paginator.num_pages }}" value="{{ projects.number }}"
                class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                onchange="window.location.href = '?projects_page=' + this.value" aria-label="Номер страницы">
            <span>из {{ projects.paginator.num_pages }}</span>
        </div>

        {% if projects.has_next %}
        <a href="?projects_page={{ projects.next_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Следующая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
        </a>
        <a href="?projects_page={{ projects.paginator.num_pages }}"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Последняя страница">
            <i class="fas fa-angle-double-right"></i>
        </a>
        {% endif %}
    </div>
</div>