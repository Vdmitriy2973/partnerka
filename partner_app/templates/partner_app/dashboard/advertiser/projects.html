{% load static %}
{% load tz %}

<div id="projects" class="page-section">
    <div class="mb-8">
        <h1 class="text-3xl font-bold">Управление проектами</h1>
        <p class="text-base-content/60">Создавайте и настраивайте проекты для партнеров</p>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <!-- Форма поиска -->
        <div class="flex-grow">
            <form method="get" action="" class="flex flex-col sm:flex-row gap-2 w-full">
                <!-- Поле поиска -->
                <div class="flex-grow">
                    <input name="projects_search" class="input input-bordered w-full" placeholder="Поиск проектов..."
                        value="{{ projects_search_query }}">
                </div>

                <!-- Группа кнопок формы -->
                <div class="flex gap-2">
                    <!-- Кнопка поиска -->
                    <button type="submit" class="btn btn-primary flex-1 sm:flex-none min-w-[100px]">
                        <i class="fas fa-search sm:mr-2"></i>
                        <span class="hidden sm:inline">Найти</span>
                    </button>

                    <!-- Кнопка сброса -->
                    <button type="reset" class="btn flex-1 sm:flex-none min-w-[100px]"
                        onclick="window.location.href='{{ request.path }}'">
                        <i class="fas fa-times sm:mr-2"></i>
                        <span class="hidden sm:inline">Сбросить</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Кнопка создания проекта -->
        <div class="sm:self-center">
            <button class="btn btn-primary w-full sm:w-auto" id="create_project">
                <i class="fas fa-plus sm:mr-2"></i>
                <span>Новый проект</span>
            </button>
        </div>
    </div>

    <!-- Уведомления -->
    {% if messages %}
    <div class="mt-4">
        {% for message in messages %}
        {% if "project_add_success" in message.extra_tags %}
        <div class="alert alert-success mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% elif "project_add_error" in message.extra_tags %}
        <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% elif "project_edit_error" in message.extra_tags %}
        <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% elif "project_edit_success" in message.extra_tags %}
        <div class="alert alert-success mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% elif "project_delete_error" in message.extra_tags %}
        <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% elif "project_delete_success" in message.extra_tags %}
        <div class="alert alert-success mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <b>{{ message }}</b>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for project in projects %}
        <div class="card bg-white shadow-sm connection-card">
            <div class="card-body pt-4">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="card-title text-lg font-bold">{{ project.name }}</h2>
                    <div class="badge {% if project.is_active %}badge-success{% else %}badge-error{% endif %} gap-2">
                        <i class="fas {% if project.is_active %}fa-check{% else %}fa-times{% endif %}"></i>
                        {% if project.is_active %}Активен{% else %}Неактивен{% endif %}
                    </div>
                </div>
                
                <div class="space-y-3 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Статус:</span>
                        <span class="badge {% if project.status == 'Подтверждено' %}badge-success
                                    {% elif project.status == 'На модерации' %}badge-warning
                                    {% else %}badge-error{% endif %}">
                            {{ project.status }}
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">URL проекта:</span>
                        <span>
                            {% if "http" in project.url %}
                            <a href="{{ project.url }}" class="text-blue-600 hover:underline" target="_blank">перейти</a>
                            {% else %}
                            <span class="text-blue-600">{{ project.url }}</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Комиссия:</span>
                        <span class="font-bold">{{ project.commission_rate }}%</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Партнеров:</span>
                        <span>{{ project.partners.count }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Время добавления:</span>
                        <span>{{ project.created_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</span>
                    </div>
                </div>
                
                <div class="absolute dropdown dropdown-end flex justify-end relative z-50">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm z-50">
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 
                   absolute z-[999] mt-1 transform-none">
                        <li class="showProjectDetailsModal" data-project-id="{{ project.id }}"
                            data-project-name="{{ project.name }}" data-project-description="{{ project.description }}"
                            data-project-url="{{ project.url }}" data-project-status="{{ project.status }}"
                            data-project-is-active="{{ project.is_active|yesno:'true,false' }}"
                            data-project-partners-count="{{ project.partners.count }}"
                            data-project-commission-rate="{{ project.commission_rate }}"
                            data-project-min-payout="{{ project.min_payout }}"
                            data-project-cookie-lifetime="{{ project.cookie_lifetime }}"
                            data-project-link-template="{{ project.link_template }}"
                            data-project-conversions-percent="{{ project.conversions_percent }}">
                            <a><i class="fas fa-eye mr-1"></i> Просмотр</a>
                        </li>
                        <li><a href="{% url 'project' project.id %}"><i class="fas fa-info mr-3"></i>Подробнее</a></li>
                        {% if project.status == 'Подтверждено' %}
                            <li class="editProjectModal" data-project-id="{{ project.id }}"
                                data-project-name="{{ project.name }}" data-project-url="{{ project.url }}"
                                data-project-description="{{ project.description }}" data-project-status="{{ project.status }}"
                                data-project-is-active="{{ project.is_active|yesno:'true,false' }}"
                                data-project-commission-rate="{{ project.commission_rate }}"
                                data-project-cookie-lifetime="{{ project.cookie_lifetime }}"
                                data-project-min-payout="{{ project.min_payout }}">
                                <a><i class="fas fa-edit mr-1"></i> Редактировать</a>
                            </li>
                        {% elif project.status == 'На модерации' %}
                            <li onclick="alert('Недоступно, пока проект на модерации')">
                                <a class="text-red-500"><i class="fas fa-edit mr-1"></i> Редактировать</a>
                            </li>
                        {% endif %}
                        <li class="delProjectModal" data-project-id="{{ project.id }}"
                            data-project-name="{{ project.name }}">
                            <a><i class="fas fa-trash-alt mr-2"></i> Удалить</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-10">
            <p class="text-gray-500">Проекты не найдены</p>
        </div>
        {% endfor %}
    </div>
    <!-- Пагинация -->

    <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
        {% if projects.has_previous %}
        <a href="?projects_page=1"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Первая страница">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="?projects_page={{ projects.previous_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Предыдущая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
        </a>
        {% endif %}

        <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
            <span class="hidden sm:inline">Страница</span>
            <input type="number" min="1" max="{{ projects.paginator.num_pages }}" value="{{ projects.number }}"
                class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                onchange="window.location.href = '?projects_page=' + this.value" aria-label="Номер страницы">
            <span>из {{ projects.paginator.num_pages }}</span>
        </div>

        {% if projects.has_next %}
        <a href="?projects_page={{ projects.next_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Следующая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
        </a>
        <a href="?projects_page={{ projects.paginator.num_pages }}"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Последняя страница">
            <i class="fas fa-angle-double-right"></i>
        </a>
        {% endif %}
    </div>
</div>