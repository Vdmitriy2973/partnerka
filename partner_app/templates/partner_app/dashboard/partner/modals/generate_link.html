<dialog id="partnerLinkModal" class="modal">
    <!-- Модальное окно -->
    <div class="modal-box max-w-4xl">
        <form method="post" id="generate_partner_link_form">
            {% csrf_token %}
            <!-- Заголовок -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    Получение партнёрской ссылки
                </h3>
                <div  onclick="document.getElementById('partnerLinkModal').close()" class="btn btn-sm btn-circle btn-ghost">
                    ✕
                </div>
            </div>

            <!-- Результат генерации -->
            <div id="generatedLinkContainer" class="mt-6 hidden">

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Ваша партнёрская ссылка</span>
                    </label>
                    <div class="relative">
                        <input name="generated_link" type="text" id="generatedLink" class="input input-bordered w-full pr-16" readonly />
                        <button id="copyLinkBtn" class="btn btn-primary absolute right-0 top-0 rounded-l-none" title="Копировать в буфер">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Фиксированный параметр pid -->
            <div class="mt-6 bg-base-200 p-4 rounded-lg">
                <h4 class="text-lg font-semibold mb-3">Обязательный параметр</h4>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 p-3 bg-base-100 rounded-lg">
                    <label class="flex-1">
                        <span class="font-medium">pid (Partner ID)</span>
                        <span class="text-sm opacity-70 block">Идентификатор партнёра</span>
                    </label>
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <input type="text" id="fixedPidInput" class="input input-bordered input-sm flex-1" readonly />
                    </div>
                </div>
            </div>

            <!-- Управление параметрами -->
            <div class="mt-4 bg-base-200 p-4 rounded-lg">
                <h4 class="text-lg font-semibold mb-3">Дополнительные параметры</h4>
                <div id="paramsControls" class="space-y-3">
                    <!-- Параметры будут добавляться сюда динамически -->
                </div>
            </div>

            <!-- Кнопки -->
            <div class="modal-action">
                <div onclick="document.getElementById('partnerLinkModal').close()" class="btn btn-ghost">
                    Закрыть
                </div>
                <button id="generateLinkBtn" type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    Сгенерировать ссылку
                </button>
            </div>
        </form>
    </div>

    <!-- Фон модального окна -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const generateBtns = document.querySelectorAll('.generate_partner_link');
        const copyBtn = document.getElementById('copyLinkBtn');
        const generatedLinkContainer = document.getElementById('generatedLinkContainer');
        const generatedLinkInput = document.getElementById('generatedLink');
        const paramsControls = document.getElementById('paramsControls');
        const generatePartnerLinkForm = document.getElementById('generate_partner_link_form');
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        const fixedPidInput = document.getElementById('fixedPidInput');
        
        let currentParams = [];
        let currentBaseUrl = '';
        let currentPid = '';
        let currentPartnershipId = '';

        // Открытие модального окна
        generateBtns.forEach(generateBtn => {
            generateBtn.addEventListener('click', function() {
                try {
                    currentPid = this.dataset.partnerId;
                    console.log(this.dataset)
                    currentPartnershipId = this.dataset.partnership;
                    currentBaseUrl = this.dataset.projectLink;
                    currentParams = JSON.parse(this.dataset.projectParams);
                    
                    fixedPidInput.value = currentPid;
                    paramsControls.innerHTML = '';
                    
                    currentParams
                        .filter(param => param.name !== 'pid')
                        .forEach(param => {
                            const paramControl = document.createElement('div');
                            paramControl.className = 'flex flex-col sm:flex-row items-start sm:items-center gap-3 p-3 bg-base-100 rounded-lg';
                            
                            const label = document.createElement('label');
                            label.className = 'flex-1';
                            label.innerHTML = `
                                <span class="font-medium">${param.name}</span>
                                ${param.description ? `<span class="text-sm opacity-70 block">Описание: ${param.description}</span>` : ''}
                                ${param.example ? `<span class="text-sm opacity-70 block">Пример: <code>${param.example}</code></span>` : ''}
                                ${param.type === 'required' ? `<span class="text-xs badge badge-error mt-1">Обязательный</span>` : '<span class="text-xs badge badge-info mt-1">Опциональный</span>'}
                            `;
                            
                            const inputGroup = document.createElement('div');
                            inputGroup.className = 'flex items-center gap-2 w-full sm:w-auto';
                            
                            if (param.type !== 'required') {
                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';
                                checkbox.className = 'toggle toggle-sm';
                                checkbox.checked = true;
                                checkbox.dataset.param = param.name;
                                
                                checkbox.addEventListener('change', function() {
                                    input.disabled = !this.checked;
                                    updateGeneratedLink();
                                });
                                
                                inputGroup.appendChild(checkbox);
                            }
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.placeholder = 'Значение';
                            input.className = 'input input-bordered input-sm flex-1';
                            input.dataset.param = param.name;
                            if (param.example) input.value = param.example;
                            
                            input.addEventListener('input', updateGeneratedLink);
                            
                            inputGroup.appendChild(input);
                            paramControl.appendChild(label);
                            paramControl.appendChild(inputGroup);
                            paramsControls.appendChild(paramControl);
                        });
                    
                    updateGeneratedLink();
                    generatedLinkContainer.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Ошибка парсинга параметров:', error);
                    alert('Ошибка при обработке параметров ссылки');
                }
            });
        });

        function updateGeneratedLink() {
            const url = new URL(currentBaseUrl);
            url.searchParams.set('pid', currentPid);
            
            document.querySelectorAll('#paramsControls input[type="text"]').forEach(input => {
                const paramName = input.dataset.param;
                const paramConfig = currentParams.find(p => p.name === paramName);
                
                if (paramConfig.type === 'required' && input.value.trim()) {
                    url.searchParams.set(paramName, input.value.trim());
                } 
                else if (paramConfig.type !== 'required') {
                    const checkbox = input.previousElementSibling;
                    if (checkbox?.checked && input.value.trim()) {
                        url.searchParams.set(paramName, input.value.trim());
                    }
                    else {
                        url.searchParams.delete(paramName)
                    }
                }
            });
            
            generatedLinkInput.value = url.toString();
        }

        generateLinkBtn.addEventListener('click', ()=>{
            generatePartnerLinkForm.action = `generate_partner_link/${currentPartnershipId}`;
            generatePartnerLinkForm.submit()
        });


        // Копировать ссылку
        copyBtn.addEventListener('click', function() {
            generatedLinkInput.select();
            document.execCommand('copy');
            
            const originalHtml = this.innerHTML;
            this.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Скопировано!
            `;
            this.classList.add('btn-success');

            setTimeout(() => {
                this.innerHTML = originalHtml;
                this.classList.remove('btn-success');
            }, 2000);
        });
    });
</script>