{% extends "partner_app/dashboard/base_lk.html" %}
{% load static %}
{% load tz %}
{% load django_vite %}
{% vite_hmr_client %}

{% block head_js_scripts %}
    {% vite_asset 'partner_app/assets/js/dashboard/partner/links/links.js' %}
{% endblock head_js_scripts %}

{% block title %}Партнёрские сссылки{% endblock title %}

{% block header %}
{% include "partner_app/dashboard/partner/header/header.html" %}
{% endblock %}

{% block main_class %}bg-base-200 min-h-screen{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">
<div id="links">
    <div class="mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-base-content mb-2">Партнерские ссылки</h1>
        <p class="text-sm sm:text-base text-base-content/60">Управляйте своими партнерскими ссылками и отслеживайте
            их эффективность</p>
    </div>

    <!-- Карточки статистики - теперь в 2 колонки на мобильных -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
        <div class="card bg-base-100 shadow-sm sm:shadow-lg">
            <div class="card-body p-3 sm:p-4 text-center">
                <i class="fas fa-link text-xl sm:text-3xl text-primary mb-1 sm:mb-2"></i>
                <div class="text-lg sm:text-2xl font-bold">{{ active_links }}</div>
                <p class="text-xs sm:text-sm text-base-content/60">Активных ссылок</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm sm:shadow-lg">
            <div class="card-body p-3 sm:p-4 text-center">
                <i class="fas fa-mouse-pointer text-xl sm:text-3xl text-info mb-1 sm:mb-2"></i>
                <div class="text-lg sm:text-2xl font-bold">{{ clicks_count }}</div>
                <p class="text-xs sm:text-sm text-base-content/60">Всего переходов</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm sm:shadow-lg">
            <div class="card-body p-3 sm:p-4 text-center">
                <i class="fas fa-chart-line text-xl sm:text-3xl text-success mb-1 sm:mb-2"></i>
                <div class="text-lg sm:text-2xl font-bold">{{ conversion }}%</div>
                <p class="text-xs sm:text-sm text-base-content/60">Средняя конверсия</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm sm:shadow-lg">
            <div class="card-body p-3 sm:p-4 text-center">
                <i class="fas fa-fire text-xl sm:text-3xl text-warning mb-1 sm:mb-2"></i>
                <div class="text-lg sm:text-2xl font-bold truncate">{{ best_link }}</div>
                <p class="text-xs sm:text-sm text-base-content/60">Лучшая ссылка</p>
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="mt-4">
        {% for message in messages %}
            {% if "delete_link_success" in message.extra_tags %}
            <div class="alert-message alert alert-success mb-4">
                <i class="fas fa-check-circle mr-2"></i>
                <b>{{ message }}</b>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Таблица с адаптивным поведением -->
    <div class="card bg-base-100 shadow-sm sm:shadow-lg">
        <div class="card-body p-3 sm:p-6">
            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3 sm:gap-4">
                <h2 class="card-title text-lg sm:text-xl">
                    <i class="fas fa-list text-primary mr-2"></i>
                    Все ссылки
                </h2>
                <div class="flex gap-2">
                    <button class="btn btn-sm sm:btn-md btn-outline">
                        <i class="fas fa-download mr-1 sm:mr-2"></i>
                        <span class="hidden sm:inline">Экспорт</span>
                    </button>
                </div>
            </div>

            <div class="overflow-visible">
                <table class="table table-zebra">
                    <thead>
                        <tr class="hidden sm:table-row">
                            <th>ID</th>
                            <th>Ссылка</th>
                            <th>Статус</th>
                            <th>Клики</th>
                            <th>Продажи</th>
                            <th>Конверсия</th>
                            <th>Доход</th>
                            <th>Создана</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in partner_links %}
                            <tr class="sm:table-row block sm:table-row mb-4 sm:mb-0">
                                <td class="hidden sm:table-cell">{{ link.id }}</td>
                                <td class="block sm:table-cell p-0 sm:p-3">
                                    <div class="flex flex-col p-3 sm:p-0">
                                        <a href="{% url 'project' link.project.id %}"><div class="font-bold">{{ link.project.name }}</div></a>
                                        <div class="text-xs text-primary break-all"><a href="{{ link.url }}">{{ link.url|truncatechars:30 }}</a></div>
                                        <div class="flex sm:hidden justify-between mt-2">
                                            <div>
                                                <span class="badge badge-{%if link.is_active %}success{% else %}error{% endif %} mr-2">{% if link.is_active %}Активна{% else %} Неактивна {% endif %} </span>
                                                <span>Клики: {{ link.clicks.all|length }}</span>
                                                <span>Конверсии: {{ link.conversions.all|length }}</span>
                                            </div>
                                            <div class="text-success font-bold">₽{{ link.conversions_total }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="hidden sm:table-cell"><span class="badge badge-{%if link.is_active %}success{% else %}error{% endif %} mr-2">{% if link.is_active %}Активна{% else %} Неактивна {% endif %} </span></td>
                                <td class="hidden sm:table-cell">{{ link.clicks.all|length }}</td>
                                <td class="hidden sm:table-cell">{{ link.conversions.all|length }}</td>
                                <td class="hidden sm:table-cell"><span class="badge badge-warning">{{ link.conversion_percent|floatformat:2 }}%</span></td>
                                <td class="hidden sm:table-cell font-bold text-success">₽{{ link.conversions_total }}</td>
                                <td class="hidden sm:table-cell">{{ link.created_at|date:"d.m.Y" }}</td>
                                <td class="block sm:table-cell p-0 sm:p-3">
                                    <div class="flex justify-end sm:justify-center p-3 sm:p-0">
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <ul tabindex="0"
                                                class="dropdown-content z-[9999] menu p-2 shadow bg-base-100 rounded-box w-52">
                                                <li class="copy_generated_link" data-clipboard-text="{{ link.url }}"><a><i class="fas fa-copy mr-2"></i>Копировать</a></li>
                                                <li class="delete_generated_link" data-link-id="{{ link.id }}"><a class="text-red-500"><i class="fas fa-trash-alt mr-2"></i>Удалить</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                    {% if not partner_links %}
                        <div class="flex flex-col justify-center items-center text-center py-10" id="empty-state">
                            <div class="text-gray-300 text-5xl mb-4">
                                <i class="fas fa-sad-cry"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-500 mb-2">Нет партнёрских ссылок</h3>
                            <p class="text-gray-400 text-sm mb-4">Подключитесь к партнерским программам и получите ссылки</p>
                        </div>
                    {% endif %}
            </div>
        </div>
    </div>
</div>
<script>

const msg = document.querySelectorAll('.alert-message').forEach(element => {
    setTimeout(function () {
      element.classList.add('opacity-0', 'scale-90', '-translate-y-2');
      setTimeout(() => element.remove(), 300);
    }, 5000)
});

document.querySelectorAll('.copy_generated_link').forEach(button => {
    button.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = button.getAttribute('data-clipboard-text');
        
        try {
            await navigator.clipboard.writeText(url);
            // Опционально: показать уведомление
            alert('Ссылка скопирована: ' + url);
        } catch (err) {
            console.error('Ошибка копирования: ', err);
            alert('Не удалось скопировать ссылку');
        }
    });
});
</script>
</div>
{% include "partner_app/dashboard/partner/links/modals/delete_link.html" %}
{% endblock %}