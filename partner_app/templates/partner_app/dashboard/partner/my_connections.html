{% load static %}
{% load tz %}

<div id="my_connections" class="page-section">
    <!-- Заголовок и статистика -->
    <div class="mb-4 sm:mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Мои подключения</h1>        
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-layer-group text-3xl text-primary mb-2"></i>
                <div id="total-platforms" class="text-2xl font-bold">{{ total_connected_projects }}</div>
                <p class="text-sm text-base-content/60">Всего подключений</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-check-circle text-3xl text-success mb-2"></i>
                <div id="approved-platforms" class="text-2xl font-bold">{{ active_connected_projects }}</div>
                <p class="text-sm text-base-content/60">Активных подключений</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-hourglass-half text-3xl text-warning mb-2"></i>
                <div id="pending-platforms" class="text-2xl font-bold">{{ suspended_connected_projects }}</div>
                <p class="text-sm text-base-content/60">Приостановленных подключений</p>
            </div>
        </div>
    </div>

    <!-- Фильтры и поиск -->
    <div class="flex justify-between items-center mb-6">
        <form method="get" action="" class="join w-full">
            <div>
                <div>
                    <input name="connections_search" class="input input-bordered join-item"
                        placeholder="Поиск проектов..." value="{{ connection_search_query }}">
                </div>
            </div>
            <div class="indicator">
                <button type="submit" class="btn join-item btn-primary">
                    <i class="fas fa-search mr-2"></i> Найти
                </button>
            </div>
            <button type="reset" class="btn join-item" onclick="window.location.href='{{ request.path }}'">
                <i class="fas fa-times mr-2"></i> Сбросить
            </button>
        </form>
    </div>

    {% if messages %}
        <div class="mt-4">
            {% for message in messages %}
                {% if "resume_partnership_success" in message.extra_tags %}
                    <div class="alert-message alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "suspend_partnership_success" in message.extra_tags %}
                    <div class="alert-message alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "stop_partnership_success" in message.extra_tags %}
                    <div class="alert-message alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "generate_link_success" in message.extra_tags %}
                    <div class="alert-message alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "generate_link_error" in message.extra_tags %}
                    <div class="alert-message alert alert-error mb-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <!-- Список подключений -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
        {% for project in connected_projects %}
        <div class="card bg-white shadow-sm connection-card">
            <div class="card-body p-3 sm:p-4">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="card-title text-sm sm:text-base"><a href="{% url 'project' project.id %}">{{ project.name }}</a></h2>
                    {% if not project.is_active %}
                    <span class="badge status-badge text-error badge-xs sm:badge-sm">
                        Приостановлен
                    </span>
                    {% endif %}
                    <span
                        class="badge status-badge {% if project.user_memberships.0.status == 'Приостановлен' %}text-gray-500
                            {% elif project.user_memberships.0.status == 'Активен'  %}text-success{% else %} text-red-500 {% endif %} badge-xs sm:badge-sm">
                        {{ project.user_memberships.0.status }}
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm mb-3">
                    <div>
                        <div class="text-gray-500">Цена за действие</div>
                        <div class="font-medium">{{ project.cost_per_action }} ₽</div>
                    </div>
                    <div>
                        <div class="text-gray-600">Рекламодатель</div>
                        <div>
                            <a href="{% url 'advertiser' project.advertiser.id %}" class="font-bold">{{ project.advertiser }}</a>
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500">Доход</div>
                        <div class="font-medium text-success">
                            ₽{{ project.conversions_total }}
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500">Дата подключения</div>
                        <div class="font-medium">
                            {% for partner in project.partner_memberships.all %}
                                {% if partner.partner == request.user %}
                                    <p>{{ partner.joined_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</p>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="card-actions justify-between">
                    <button class="show_project_stats btn btn-primary btn-xs sm:btn-sm"
                        data-project-name="{{ project.name }}"
                        data-project-cost="{{ project.cost_per_action }}"
                        data-conversions-count="{{ project.conversions_count }}"
                        data-conversions-percent="{{ project.conversions_percent }}"
                        data-clicks-count="{{ project.clicks_count }}"
                        {% if not project.project_links.all %}disabled{% endif %}>
                        <i class="fas fa-chart-line"></i>
                        <span class="hidden sm:inline ml-1">Статистика</span>
                    </button>
                    {% if not project.project_links.all %}
                        <button data-partnership="{% for partnership in project.partner_memberships.all %}{% if partnership.partner == request.user %}{{ partnership.id }}{% endif %}{% endfor %}" data-project-params="[{% for param in project.params.all %}{&quot;name&quot;: &quot;{{ param.name|escapejs }}&quot;,&quot;description&quot;: &quot;{{ param.description|escapejs }}&quot;,&quot;type&quot;: &quot;{{ param.param_type|escapejs }}&quot;,&quot;example&quot;: &quot;{{ param.example_value|escapejs }}&quot;}{% if not forloop.last %},{% endif %}{% endfor %}]"
                            data-partner-id="{% for partnership in project.partner_memberships.all %}{% if partnership.partner == request.user %}{{ partnership.partner.id }}{% endif %}{% endfor %}"
                            data-project-link="{{ project.link_template }}" onclick="document.getElementById('partnerLinkModal').showModal()" class="generate_partner_link btn btn-primary btn-xs sm:btn-sm">
                                Получить ссылку
                        </button>
                    {% endif %}
                    
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                        <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                            {% if project.partner_memberships.first.status == 'Активен' %}
                            <li class="suspend_partnership" 
                                data-project-id="{{ project.id }}"
                                data-project-name="{{ project.name }}">
                                <a>
                                    <i class="fas fa-edit mr-2"></i>Приостановить
                                </a>
                            </li>
                            {% elif project.partner_memberships.first.status == 'Приостановлен' %}
                            <li class="resume_partnership" 
                                data-project-id="{{ project.id }}"
                                data-project-name="{{ project.name }}">
                                <a>
                                    <i class="fas fa-edit mr-2"></i>Возобновить
                                </a>
                            </li>
                            {% endif %}
                            <li class="text-error stop_partnership" 
                                data-project-id="{{ project.id }}"
                                data-project-name="{{ project.name }}">
                                <a>
                                    <i class="fas fa-trash-alt mr-2"></i>Отключиться
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if not connected_projects %}
    <div class="flex flex-col justify-center items-center text-center py-10" id="empty-state">
        <div class="text-gray-300 text-5xl mb-4">
            <i class="fas fa-sad-cry"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-500 mb-2">Нет подключенных программ</h3>
        <p class="text-gray-400 text-sm mb-4">Подключитесь к партнерским программам и начните зарабатывать</p>
        <button class="btn btn-primary btn-sm nav-item" data-page="offers">
            <i class="fas fa-plus mr-2"></i>
            Найти программы
        </button>
    </div>
    {% endif %}

    <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
        {% if connected_projects.has_previous %}
        <a href="?connected_projects_page=1"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Первая страница">
            <i class="fas fa-angle-double-left"></i>
        </a>
        <a href="?connected_projects_page={{ connected_projects.previous_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Предыдущая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
        </a>
        {% endif %}

        <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
            <span class="hidden sm:inline">Страница</span>
            <input type="number" min="1" max="{{ connected_projects.paginator.num_pages }}"
                value="{{ connected_projects.number }}"
                class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                onchange="window.location.href = '?connected_projects_page=' + this.value" aria-label="Номер страницы">
            <span>из {{ connected_projects.paginator.num_pages }}</span>
        </div>

        {% if connected_projects.has_next %}
        <a href="?connected_projects_page={{ connected_projects.next_page_number }}"
            class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
            <span class="hidden sm:inline">Следующая</span>
            <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
        </a>
        <a href="?connected_projects_page={{ connected_projects.paginator.num_pages }}"
            class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
            aria-label="Последняя страница">
            <i class="fas fa-angle-double-right"></i>
        </a>
        {% endif %}
    </div>
</div>