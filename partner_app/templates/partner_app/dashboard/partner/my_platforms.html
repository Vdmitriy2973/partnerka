{% load static %}
{% load tz %}

<div id="my_platforms" class="page-section">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-base-content mb-2">Мои площадки</h1>
        <p class="text-base-content/60">Добавляйте и управляйте своими источниками трафика (TikTok, YouTube, блоги,
            сайты и др.)</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-layer-group text-3xl text-primary mb-2"></i>
                <div id="total-platforms" class="text-2xl font-bold">{{ total_platforms }}</div>
                <p class="text-sm text-base-content/60">Всего площадок</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-check-circle text-3xl text-success mb-2"></i>
                <div id="approved-platforms" class="text-2xl font-bold">{{ approved_platforms_count }}</div>
                <p class="text-sm text-base-content/60">Подтверждено</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fas fa-hourglass-half text-3xl text-warning mb-2"></i>
                <div id="pending-platforms" class="text-2xl font-bold">{{ pending_platforms_count }}</div>
                <p class="text-sm text-base-content/60">Ожидают модерации</p>
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body text-center">
                <i class="fa fa-ban text-3xl text-error mb-2"></i>
                <div id="pending-platforms" class="text-2xl font-bold">{{ rejected_platforms_count }}</div>
                <p class="text-sm text-base-content/60">Отклонено</p>
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-6">
        <form method="get" action="" class="join w-full">
            <div>
                <div>
                    <input name="platforms_search" class="input input-bordered join-item"
                        placeholder="Поиск площадок..." value="{{ platforms_search_query }}">
                </div>
            </div>
            <div class="indicator">
                <button type="submit" class="btn join-item btn-primary">
                    <i class="fas fa-search mr-2"></i> Найти
                </button>
            </div>
            <button type="reset" class="btn join-item" onclick="window.location.href='{{ request.path }}'">
                <i class="fas fa-times mr-2"></i> Сбросить
            </button>
        </form>
    </div>

    <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-2 lg:p-4">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 gap-3">
                <h2 class="card-title text-lg lg:text-xl flex items-center gap-2">
                    <i class="fas fa-globe text-primary"></i>
                    <span class="whitespace-nowrap">Все площадки</span>
                </h2>
                <button id="btn-add-platform" class="btn btn-primary btn-sm lg:btn-md flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span class="hidden lg:inline">Добавить площадку</span>
                    <span class="lg:hidden">Добавить</span>
                </button>
            </div>
            <!-- Уведомления -->
            {% if messages %}
            <div class="mt-4">
                {% for message in messages %}
                    {% if "platform_add_success" in message.extra_tags %}
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "platform_add_error" in message.extra_tags %}
                    <div class="alert alert-error mb-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "platform_edit_error" in message.extra_tags %}
                    <div class="alert alert-error mb-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "platform_edit_success" in message.extra_tags %}
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "platform_delete_error" in message.extra_tags %}
                    <div class="alert alert-error mb-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% elif "platform_delete_success" in message.extra_tags %}
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle mr-2"></i>
                        <b>{{ message }}</b>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="overflow-visible">
                <table class="table table-zebra table-pin-rows">
                    <!-- Заголовок таблицы (скрыт на мобильных) -->
                    {% if platforms %}
                    <thead class="hidden lg:table-header-group">
                        <tr>
                            <th class="whitespace-nowrap">Название</th>
                            <th class="whitespace-nowrap">Тип</th>
                            <th class="whitespace-nowrap">URL / ID</th>
                            <th class="whitespace-nowrap">Статус</th>
                            <th class="whitespace-nowrap">Дата добавления</th>
                            <th class="whitespace-nowrap">Действия</th>
                        </tr>
                    </thead>
                    {% endif %}
                    <tbody id="platforms-tbody">
                        {% for platform in platforms %}
                        <tr
                            class="flex flex-col sm:table-row border-b border-base-200 last:border-b-0 overflow-visible">
                            <!-- Мобильная версия (вертикальная карточка) -->
                            <td class="lg:hidden p-4">
                                <div class="flex flex-col gap-2">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <strong class="text-lg">{{ platform.name }}</strong>
                                            <div class="text-sm text-gray-500">{{ platform.get_platform_type_display }}
                                            </div>
                                        </div>
                                        <span
                                            class="badge {% if platform.status == 'Подтверждено' %}badge-success{% elif platform.status == 'На модерации' %}badge-warning{% else %}badge-error{% endif %}">
                                            {{ platform.status }}
                                        </span>

                                    </div>

                                    <div class="text-sm text-primary truncate">
                                        {% if "http" in platform.url_or_id %}
                                        <a href='{{ platform.url_or_id }}' target="_blank">URL</a>
                                        {% else %}
                                        {{ platform.url_or_id }}
                                        {% endif %}
                                    </div>

                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">{{ platform.created_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</span>
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <ul tabindex="0"
                                                class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40">
                                                <li class="show_partner_platforms" data-platform-name="{{ platform.name }}"
                                                    data-platform-type="{{ platform.get_platform_type_display }}"
                                                    data-platform-income="{{ platform.income }}"
                                                    data-platform-conversions-percent="{{ platform.conversions_percent }}"
                                                    data-platform-clicks-count="{{ platform.clicks_count }}"
                                                    data-platform-conversions-count="{{ platform.conversions_count }}"
                                                    data-platform-created-at="{{ platform.created_at }}"
                                                    data-platform-status="{{ platform.is_active }}">
                                                    <a>
                                                        <i class="fa-solid fa-square-poll-vertical mr-2"></i>Стат.
                                                    </a>
                                                </li>
                                                <li class="edit-platform-btn" data-platform-id="{{ platform.id }}"
                                                    data-platform-name="{{ platform.name }}"
                                                    data-platform-type="{{ platform.get_platform_type_display }}"
                                                    data-platform-url="{{ platform.url_or_id }}"
                                                    data-platform-description="{{ platform.description }}">
                                                    <a href="#">
                                                        <i class="fas fa-edit mr-2"></i>Ред.
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#" class="text-error delete-platform-btn"
                                                        data-platform-id="{{ platform.id }}"
                                                        data-platform-name="{{ platform.name }}">
                                                        <i class="fas fa-trash-alt mr-2"></i>Удалить
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <!-- Десктопная версия -->
                            <td class="hidden lg:table-cell"><strong>{{ platform.name }}</strong></td>
                            <td class="hidden lg:table-cell">{{ platform.get_platform_type_display }}</td>
                            <td class="hidden lg:table-cell text-sm text-primary truncate max-w-[150px]">
                                <div class="text-sm text-primary truncate">
                                    {% if "http" in platform.url_or_id %}
                                    <a href='{{ platform.url_or_id }}' target="_blank">URL</a>
                                    {% else %}
                                    {{ platform.url_or_id }}
                                    {% endif %}
                                </div>
                            </td>
                            <td class="hidden lg:table-cell">
                                <span
                                    class="badge {% if platform.status == 'Подтверждено' %}badge-success{% elif platform.status == 'На модерации' %}badge-warning{% else %}badge-error{% endif %}">
                                    {{ platform.status }}
                                </span>
                            </td>
                            <td class="hidden lg:table-cell whitespace-nowrap">{{ platform.created_at|timezone:"Europe/Moscow"|date:"j E Y H:i" }}</td>
                            <td class="hidden lg:table-cell">
                                <div class="dropdown dropdown-end">
                                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </div>
                                    <ul tabindex="0"
                                        class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                        <li class="show_partner_platforms" data-platform-name="{{ platform.name }}"
                                            data-platform-type="{{ platform.get_platform_type_display }}"
                                            data-platform-income="{{ platform.income }}"
                                            data-platform-conversions-percent="{{ platform.conversions_percent }}"
                                            data-platform-clicks-count="{{ platform.clicks_count }}"
                                            data-platform-conversions-count="{{ platform.conversions_count }}"
                                            data-platform-created-at="{{ platform.created_at }}"
                                            data-platform-status="{{ platform.is_active }}">
                                            <a>
                                                <i class="fa-solid fa-square-poll-vertical mr-2"></i>Статистика
                                            </a>
                                        </li>
                                        <li class="edit-platform-btn" data-platform-id="{{ platform.id }}"
                                            data-platform-name="{{ platform.name }}"
                                            data-platform-type="{{ platform.get_platform_type_display }}"
                                            data-platform-url="{{ platform.url_or_id }}"
                                            data-platform-description="{{ platform.description }}">
                                            <a>
                                                <i class="fas fa-edit mr-2"></i>Редактировать
                                            </a>
                                        </li>
                                        <li class="text-error delete-platform-btn" data-platform-id="{{ platform.id }}"
                                            data-platform-name="{{ platform.name }}">
                                            <a>
                                                <i class="fas fa-trash-alt mr-2"></i>Удалить
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <div class="col-span-full text-center py-10">
                            <p class="text-gray-500">Нет добавленных площадок<br>Добавьте площадки для отслеживания
                                статистики и заработка</p>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
                    {% if platforms.has_previous %}
                    <a href="?platforms_page=1"
                        class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                        aria-label="Первая страница">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?platforms_page={{ platforms.previous_page_number }}"
                        class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                        <span class="hidden sm:inline">Предыдущая</span>
                        <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
                    </a>
                    {% endif %}

                    <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
                        <span class="hidden sm:inline">Страница</span>
                        <input type="number" min="1" max="{{ platforms.paginator.num_pages }}"
                            value="{{ platforms.number }}"
                            class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                            onchange="window.location.href = '?platforms_page=' + this.value"
                            aria-label="Номер страницы">
                        <span>из {{ platforms.paginator.num_pages }}</span>
                    </div>

                    {% if platforms.has_next %}
                    <a href="?platforms_page={{ platforms.next_page_number }}"
                        class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                        <span class="hidden sm:inline">Следующая</span>
                        <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <a href="?platforms_page={{ platforms.paginator.num_pages }}"
                        class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                        aria-label="Последняя страница">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>