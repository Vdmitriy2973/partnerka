{% extends 'partner_app/base.html' %}
{% load tz %}

{% block title %} Проект - {{ project.name }} {% endblock %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-base-100 to-base-200 py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    <div class="max-w-6xl mx-auto">
        <!-- Хлебные крошки -->
        <div class="text-sm breadcrumbs mb-6">
            <ul>
                <li><a href="/">Главная</a></li>
                <li><a href="{% url 'dashboard' %}">Личный кабинет</a></li>
                <li class="font-semibold">Проект</li>
            </ul>
        </div>

        <!-- Основная информация о проекте -->
        <div class="card bg-base-100 shadow-lg mb-8">
            <div class="card-body">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h1 class="card-title text-3xl font-bold">{{ project.name }}</h1>
                    <div
                        class="badge {% if project.is_active %}badge-success{% else %}badge-error{% endif %} gap-2 text-lg">
                        <i class="fas {% if project.is_active %}fa-check{% else %}fa-times{% endif %}"></i>
                        {% if project.is_active %}Активен{% else %}Неактивен{% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Карточка с основной информацией -->
                    <div class="bg-base-200 p-6 rounded-box">
                        <h2 class="text-xl font-semibold mb-4">Основная информация</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Статус:</span>
                                <span
                                    class="badge {% if project.status == 'Подтверждено' %}badge-success{% elif project.status == 'На модерации' %}badge-warning{% else %}badge-error{% endif %}">
                                    {{ project.status }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Дата создания:</span>
                                <span>{{ project.created_at|date:"d.m.Y" }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Комиссия:</span>
                                <span class="font-bold">{{ project.cost_per_action }} ₽</span>
                            </div>
                        </div>
                    </div>

                    <!-- Карточка с URL проекта -->
                    <div class="bg-base-200 p-6 rounded-box">
                        {% if "http" in project.url %}
                            <h2 class="text-xl font-semibold mb-4">URL проекта</h2>
                            <div class="flex items-center justify-between bg-base-100 p-3 rounded-lg">
                            <span class="truncate">{{ project.url|truncatechars:20 }}</span>
                            <a id="project-url" href="{{ project.url }}" target="_blank" class="btn btn-sm btn-ghost">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            </div>
                        {% else %}
                            <h2 class="text-xl font-semibold mb-4">ID проекта</h2>
                            <div class="flex items-center justify-between bg-base-100 p-3 rounded-lg">
                            <span id="project-id" class="truncate">{{ project.url|truncatechars:20 }}</span>
                            </div>
                        {% endif %}
                        <div class="mt-4">
                            <button id="copy-link" onclick="copyToClipboard()" class="btn btn-primary btn-sm">
                            <i class="fas fa-copy mr-2"></i> Копировать
                            </button>
                        </div>
                    </div>

                    <!-- Карточка статистики -->
                    <div class="bg-base-200 p-6 rounded-box">
                        <h2 class="text-xl font-semibold mb-4">Статистика</h2>
                        <div class="stats stats-vertical lg:stats-horizontal shadow bg-base-100">
                            <div class="stat">
                                <div class="stat-title">Партнеров</div>
                                <div class="stat-value">{{ total_partners }}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-title">Конверсия</div>
                                <div class="stat-value">{{ project.conversions_percent }}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список партнеров -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">Подключенные партнеры ({{ active_partners }})</h2>

                <!-- Фильтры и поиск -->
                {% if partnerships %}
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                    <div class="join">
                        <input class="input input-bordered join-item w-full md:w-64" placeholder="Поиск партнеров...">
                        <button class="btn join-item btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Таблица партнеров -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-pin-rows">
                        <thead>
                            <tr>
                                <th class="hidden sm:table-cell">ID</th>
                                <th>Партнер</th>
                                <th class="hidden md:table-cell">Подключен</th>
                                <th class="hidden lg:table-cell">Конверсии</th>
                                <th class="hidden lg:table-cell">Заработано</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for partnership in partnerships %}
                            <tr>
                                <td class="hidden sm:table-cell">{{ partnership.partner.id }}</td>
                                <td>
                                    <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                                        <div>
                                            <div class="font-bold">
                                                <a href="{% url 'partner' partnership.partner.id %}"
                                                    class="link link-hover">
                                                    {{ partnership.partner.first_name }} {{ partnership.partner.last_name }}
                                                </a>
                                            </div>
                                            <div class="text-xs text-gray-500 truncate max-w-[120px] sm:max-w-none">
                                                {{ partnership.partner.email|default:"Отсутствует" }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="hidden md:table-cell">
                                    <span class="whitespace-nowrap">{{ partnership.joined_at|date:"d.m.Y" }}</span>
                                </td>
                                <td class="hidden lg:table-cell">{{ partnership.partner.partner_profile.conversions.all|length }}</td>
                                <td class="hidden lg:table-cell">₽{{ partnership.conversions_total }}</td>
                                <td>
                                    <span
                                        class="badge {% if partnership.status == 'Активен' %}badge-success{% else %}badge-error{% endif %} badge-sm whitespace-nowrap">
                                        {% if partnership.partner.is_active %}Активен{% else %}Неактивен{% endif %}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">Нет подключенных партнеров</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Пагинация -->
                <div class="pagination flex flex-wrap justify-center items-center gap-2 my-6 px-2">
                    {% if partnerships.has_previous %}
                    <a href="?partners_page=1"
                        class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                        aria-label="Первая страница">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?partners_page={{ partnerships.previous_page_number }}"
                        class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                        <span class="hidden sm:inline">Предыдущая</span>
                        <span class="sm:hidden"><i class="fas fa-chevron-left"></i></span>
                    </a>
                    {% endif %}

                    <div class="flex items-center mx-1 md:mx-3 text-sm md:text-base">
                        <span class="hidden sm:inline">Страница</span>
                        <input type="number" min="1" max="{{ partnerships.paginator.num_pages }}"
                            value="{{ partnerships.number }}"
                            class="input input-bordered input-sm md:input-md w-12 md:w-16 mx-1 md:mx-2 text-center transition-all duration-200 focus:ring-2 focus:ring-primary focus:border-transparent"
                            onchange="window.location.href = '?partners_page=' + this.value"
                            aria-label="Номер страницы">
                        <span>из {{ partnerships.paginator.num_pages }}</span>
                    </div>

                    {% if partnerships.has_next %}
                    <a href="?partners_page={{ partnerships.next_page_number }}"
                        class="btn btn-sm md:btn-md btn-outline transition-all duration-200 hover:scale-[1.02]">
                        <span class="hidden sm:inline">Следующая</span>
                        <span class="sm:hidden"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <a href="?partners_page={{ partnerships.paginator.num_pages }}"
                        class="btn btn-sm btn-square md:btn-md btn-primary transition-all duration-200 hover:scale-105"
                        aria-label="Последняя страница">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard() {
        // Определяем, что копируем (URL или ID)
        const textToCopy = document.getElementById('project-url')
            ? document.getElementById('project-url').href
            : document.getElementById('project-id').textContent.trim();

        // Используем Clipboard API
        console.log(textToCopy)
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                // Визуальная обратная связь
                const btn = document.getElementById('copy-link');
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Скопировано!';

                // Возвращаем исходный текст через 2 секунды
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy mr-2"></i> Копировать';
                }, 2000);
            })
            .catch(err => {
                console.error('Ошибка копирования: ', err);
                alert('Не удалось скопировать. Разрешите доступ к буферу обмена.');
            });
    }
</script>

{% endblock %}
